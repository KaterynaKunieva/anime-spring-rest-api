<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <property name="uuid_function" value="gen_random_uuid()" dbms="postgresql"/>
    <property name="uuid_function" value="random_uuid()" dbms="h2"/>

    <changeSet id="create_table_author" author="admin">
        <createTable tableName="author">
            <column name="id" type="uuid" defaultValueComputed="${uuid_function}">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(100)">
                <constraints nullable="false" unique="true" uniqueConstraintName="author_name_key"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create_table_anime" author="admin">
        <createTable tableName="anime">
            <column name="id" type="uuid" defaultValueComputed="${uuid_function}">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="title" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="score" type="decimal"/>
            <column name="release_year" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="author_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_anime_author" references="author(id)"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create_temp_author_table" author="admin">
        <createTable tableName="author_temp">
            <column name="name" type="varchar(255)"/>
        </createTable>
    </changeSet>

    <changeSet id="load_data_to_temp_author" author="admin">
        <loadData tableName="author_temp" file="authors.csv">
            <column name="name" type="string" />
        </loadData>
    </changeSet>

    <changeSet id="merge_authors_case_insensitive" author="admin" dbms="postgresql">
        <sql>
            INSERT INTO author (name)
            SELECT DISTINCT ON (LOWER(name)) name
            FROM author_temp
            WHERE name IS NOT NULL
            ON CONFLICT (name) DO NOTHING;
        </sql>
    </changeSet>

    <changeSet id="drop_temp_author_table" author="admin">
        <dropTable tableName="author_temp"/>
    </changeSet>

</databaseChangeLog>